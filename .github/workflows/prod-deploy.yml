name: Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.146.0
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Hugo
        run: |
          wget -O ${{ runner.temp }}/hugo.tar.gz https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz
          tar -xzf ${{ runner.temp }}/hugo.tar.gz -C ${{ runner.temp }}
          sudo mv ${{ runner.temp }}/hugo /usr/local/bin/

      - name: Build with Hugo
        env:
          HUGO_ENVIRONMENT: production
          HUGO_ENV: production
          HUGO_PARAMS_FORMSPREEENDPOINT: ${{ secrets.FORMSPREE_ENDPOINT }}
        run: |
          hugo --minify --baseURL "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

      - name: Deploy to gh-pages
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Setup git credentials
          git config --global credential.helper store
          echo "https://x-access-token:${{ github.token }}@github.com" > ~/.git-credentials

          # Fetch gh-pages branch
          git fetch origin gh-pages:gh-pages 2>/dev/null || true

          # Create a temporary directory for gh-pages content
          TEMP_DIR=$(mktemp -d)

          # If gh-pages branch exists, check it out to temp directory to preserve PR previews
          if git rev-parse --verify gh-pages >/dev/null 2>&1; then
            git clone --branch gh-pages --single-branch https://github.com/${{ github.repository }}.git "$TEMP_DIR"
            # Remove old production files but keep pr-* directories
            cd "$TEMP_DIR"
            find . -maxdepth 1 ! -name 'pr-*' ! -name '.' ! -name '.git' -exec rm -rf {} +
          else
            cd "$TEMP_DIR"
            git init
            git checkout --orphan gh-pages
          fi

          # Copy built files to root (excluding pr-* directories)
          cp -r ${{ github.workspace }}/public/* "$TEMP_DIR/"

          # Add .nojekyll to prevent GitHub Pages from processing with Jekyll
          touch "$TEMP_DIR/.nojekyll"

          # Navigate to temp directory and push
          cd "$TEMP_DIR"
          git add .
          git commit -m "Deploy production site from main branch" || echo "No changes to commit"
          git push --force https://github.com/${{ github.repository }}.git gh-pages
