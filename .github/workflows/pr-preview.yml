name: PR Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: write
  pull-requests: write

defaults:
  run:
    shell: bash

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.146.0
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Hugo
        run: |
          wget -O ${{ runner.temp }}/hugo.tar.gz https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz
          tar -xzf ${{ runner.temp }}/hugo.tar.gz -C ${{ runner.temp }}
          sudo mv ${{ runner.temp }}/hugo /usr/local/bin/

      - name: Build with Hugo
        env:
          HUGO_ENVIRONMENT: production
          HUGO_ENV: production
        run: |
          hugo --minify --baseURL "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.pull_request.number }}/"

      - name: Deploy to gh-pages branch
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Setup git credentials
          git config --global credential.helper store
          echo "https://x-access-token:${{ github.token }}@github.com" > ~/.git-credentials
          
          # Fetch gh-pages branch
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          
          # Create a temporary directory for gh-pages content
          TEMP_DIR=$(mktemp -d)
          
          # If gh-pages branch exists, check it out to temp directory
          if git rev-parse --verify gh-pages >/dev/null 2>&1; then
            git clone --branch gh-pages --single-branch https://github.com/${{ github.repository }}.git "$TEMP_DIR"
          else
            cd "$TEMP_DIR"
            git init
            git checkout --orphan gh-pages
          fi
          
          # Create pr-specific directory in temp location
          mkdir -p "$TEMP_DIR/pr-${{ github.event.pull_request.number }}"
          
          # Copy built files to pr directory
          cp -r ${{ github.workspace }}/public/* "$TEMP_DIR/pr-${{ github.event.pull_request.number }}/"
          
          # Navigate to temp directory and push
          cd "$TEMP_DIR"
          git add .
          git commit -m "Deploy preview for PR #${{ github.event.pull_request.number }}" || echo "No changes to commit"
          git push --force https://github.com/${{ github.repository }}.git gh-pages

      - name: Comment PR
        uses: actions/github-script@v8
        with:
          script: |
            const url = `https://${context.repo.owner}.github.io/${context.repo.repo}/pr-${context.payload.pull_request.number}/`;
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview deployment')
            );
            
            const body = `ðŸš€ **Preview deployment ready!**\n\n` +
                        `âœ¨ Preview URL: ${url}\n\n` +
                        `The preview will be automatically updated with each commit and cleaned up when the PR is closed or merged.\n\n` +
                        `> **Note:** It may take a few minutes for GitHub Pages to update with your changes.`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
            }

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Remove PR preview directory
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Fetch and checkout gh-pages branch
          git fetch origin gh-pages:gh-pages 2>/dev/null || exit 0
          git checkout gh-pages || exit 0
          
          # Remove the pr directory if it exists
          if [ -d "pr-${{ github.event.pull_request.number }}" ]; then
            rm -rf pr-${{ github.event.pull_request.number }}
            
            # Commit and push
            git add -A
            git commit -m "Remove preview for closed PR #${{ github.event.pull_request.number }}"
            git push origin gh-pages
          else
            echo "PR preview directory not found, nothing to clean up"
          fi

      - name: Comment PR
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `ðŸ§¹ **Preview deployment cleaned up**\n\n` +
                    `The preview deployment has been removed from GitHub Pages.`
            });
